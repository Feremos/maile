<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>System Maili U偶ytkownik贸w</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/water.css@2/out/water.css">
  <style>
    /* Minimalne dostosowania do water.css */
    body {
      max-width: 1200px;
      margin: 0 auto;
      padding: 1rem;
    }

    .header {
      text-align: center;
      margin-bottom: 2rem;
      padding-bottom: 1rem;
      border-bottom: 2px solid var(--border);
    }

    .controls-section {
      background: var(--background-alt);
      padding: 1.5rem;
      border-radius: 8px;
      margin-bottom: 2rem;
      border: 1px solid var(--border);
    }

    .form-group {
      margin-bottom: 1rem;
    }

    .email-accounts-tabs,
    .category-tabs {
      background: var(--background-alt);
      padding: 1rem;
      border-radius: 8px;
      margin: 1rem 0;
      border: 1px solid var(--border);
    }

    .email-accounts-tabs h3,
    .category-tabs h3 {
      text-align: center;
      margin-bottom: 1rem;
      color: var(--text-main);
    }

    .tabs-container {
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
      justify-content: center;
    }

    .account-tab,
    .tab-link {
      display: inline-block;
      padding: 0.5rem 1rem;
      background: var(--background);
      color: var(--text-main);
      text-decoration: none;
      border: 1px solid var(--border);
      border-radius: 4px;
      transition: all 0.2s ease;
    }

    .account-tab:hover,
    .tab-link:hover,
    .account-tab.active,
    .tab-link.active {
      background: var(--button-base);
      color: var(--button-text);
      text-decoration: none;
    }

    .email-card {
      background: var(--background-alt);
      border: 1px solid var(--border);
      border-radius: 8px;
      margin-bottom: 2rem;
      overflow: hidden;
    }

    .email-header {
      background: var(--background);
      padding: 1.5rem;
      border-bottom: 1px solid var(--border);
    }

    .email-meta {
      display: flex;
      flex-wrap: wrap;
      gap: 1rem;
      margin-bottom: 1rem;
    }

    .email-meta-item {
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .email-meta-label {
      font-weight: bold;
      color: var(--text-main);
    }

    .email-subject {
      font-size: 1.1rem;
      font-weight: bold;
      margin-bottom: 1rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .classification-date-row {
      display: flex;
      justify-content: space-between;
      align-items: flex-end;
      flex-wrap: wrap;
      gap: 0.5rem;
    }

    .classification-badge {
      background: var(--button-base);
      color: var(--button-text);
      padding: 0.3rem 0.8rem;
      border-radius: 20px;
      font-weight: bold;
      font-size: 0.9rem;
    }

    .email-date {
      color: var(--text-muted);
      font-size: 0.9rem;
    }

    .email-body {
      padding: 1.5rem;
    }

    .email-body-header {
      font-weight: bold;
      margin-bottom: 0.5rem;
      font-size: 1rem;
    }

    .email-content {
      background: var(--background);
      border: 1px solid var(--border);
      border-radius: 4px;
      padding: 1rem;
      margin-bottom: 1rem;
      white-space: pre-wrap;
      max-height: 300px;
      overflow-y: auto;
      word-wrap: break-word;
    }

    .email-summary {
      background: var(--background);
      border: 1px solid var(--border);
      border-radius: 4px;
      padding: 1rem;
      margin-bottom: 1rem;
    }

    .email-summary strong {
      display: block;
      margin-bottom: 0.5rem;
    }

    .reply-section {
      background: var(--background);
      border-top: 1px solid var(--border);
      padding: 1.5rem;
    }

    .reply-section h4 {
      margin-bottom: 1rem;
    }

    .reply-textarea {
      width: 100%;
      min-height: 120px;
      resize: vertical;
      margin-bottom: 1rem;
    }

    .message {
      text-align: center;
      padding: 1rem;
      border-radius: 4px;
      margin: 1rem 0;
    }

    .message.error {
      background: #fee;
      border: 1px solid #fcc;
      color: #c33;
    }

    .message.success {
      background: #efe;
      border: 1px solid #cfc;
      color: #393;
    }

    .no-emails {
      text-align: center;
      padding: 3rem;
      color: var(--text-muted);
    }

    .stats-bar {
      display: flex;
      justify-content: center;
      gap: 2rem;
      margin: 2rem 0;
      padding: 1rem;
      background: var(--background-alt);
      border-radius: 4px;
      flex-wrap: wrap;
    }

    .stat-item {
      text-align: center;
    }

    .stat-number {
      font-size: 1.5rem;
      font-weight: bold;
      display: block;
    }

    .stat-label {
      font-size: 0.9rem;
      color: var(--text-muted);
    }

    /* Responsywno */
    @media (max-width: 768px) {
      .email-meta {
        flex-direction: column;
        gap: 0.5rem;
      }
      
      .classification-date-row {
        flex-direction: column;
        align-items: flex-start;
      }
      
      .tabs-container {
        flex-direction: column;
      }
      
      .account-tab,
      .tab-link {
        text-align: center;
      }
    }
  </style>
</head>
<body>
  <div class="header">
    <h1>System Maili U偶ytkownik贸w</h1>
  </div>

  <div class="controls-section">
    <h3>Dodaj nowe konto e-mail</h3>
    <form method="post" action="/add_email_account">
      <div class="form-group">
        <label for="email_address">Adres e-mail:</label>
        <input type="email" id="email_address" name="email_address" required placeholder="przyklad@firma.pl">
      </div>
      <button type="submit">Dodaj konto</button>
    </form>

    {% if add_email_error %}
      <div class="message error">{{ add_email_error }}</div>
    {% endif %}
    {% if add_email_message %}
      <div class="message success">{{ add_email_message }}</div>
    {% endif %}
  </div>

  <!-- Taby wyboru kont email -->
  <div class="email-accounts-tabs">
    <h3> Wybierz konto e-mail</h3>
    <div class="tabs-container">
      <a href="/{% if active_category %}category/{{ active_category }}{% endif %}" 
         class="account-tab {% if not selected_email %}active{% endif %}">
        Wszystkie konta
      </a>
      {% for email in user_visible_emails %}
        <a href="/{% if active_category %}category/{{ active_category }}{% endif %}?selected_email={{ email | urlencode }}" 
           class="account-tab {% if email == selected_email %}active{% endif %}"
           title="{{ email }}">
        {{ email }}
        </a>
      {% endfor %}
    </div>
  </div>

  <!-- Taby kategorii -->
  <div class="category-tabs">
    <h3>Kategorie wiadomoci</h3>
    <div class="tabs-container">
      <a href="/{% if selected_email %}?selected_email={{ selected_email | urlencode }}{% endif %}" 
         class="tab-link {% if not active_category %}active{% endif %}">
        Wszystkie
      </a>
      <a href="/category/faktura{% if selected_email %}?selected_email={{ selected_email | urlencode }}{% endif %}" 
         class="tab-link {% if active_category == 'faktura' %}active{% endif %}">
        Faktury
      </a>
      <a href="/category/reklamacja{% if selected_email %}?selected_email={{ selected_email | urlencode }}{% endif %}" 
         class="tab-link {% if active_category == 'reklamacja' %}active{% endif %}">
        Reklamacje
      </a>
      <a href="/category/oferta{% if selected_email %}?selected_email={{ selected_email | urlencode }}{% endif %}" 
         class="tab-link {% if active_category == 'oferta' %}active{% endif %}">
        Oferty
      </a>
      <a href="/category/rezygnacja{% if selected_email %}?selected_email={{ selected_email | urlencode }}{% endif %}" 
         class="tab-link {% if active_category == 'rezygnacja' %}active{% endif %}">
        Rezygnacje
      </a>
      <a href="/category/brak%20klasyfikacji{% if selected_email %}?selected_email={{ selected_email | urlencode }}{% endif %}" 
         class="tab-link {% if active_category == 'brak klasyfikacji' %}active{% endif %}">
        Inne
      </a>
      <a href="/archiwum{% if selected_email %}?selected_email={{ selected_email | urlencode }}{% endif %}" 
         class="tab-link {% if active_category == 'archiwum' %}active{% endif %}">
        Archiwum
      </a>
    </div>
  </div>

  {% if error %}
    <div class="message error">{{ error }}</div>
  {% endif %}
  {% if message %}
    <div class="message success">{{ message }}</div>
  {% endif %}

  <div class="emails-section">
    {% for email in emails %}
    <div class="email-card">
      <div class="email-header">
        <div class="email-meta">
          <div class="email-meta-item">
            <span class="email-meta-label">Od:</span>
            <span>{{email.sent_from}}</span>
          </div>
          <div class="email-meta-item">
            <span class="email-meta-label">Do:</span>
            <span>{{email.sent_to}}</span>
          </div>
        </div>
        
        <div class="email-subject">
          <span class="email-meta-label">Temat:</span>
          <span>{{email.subject}}</span>
        </div>

        <div class="classification-date-row">
          <div class="classification-badge">
            {{ email.classification }}
          </div>

          <div class="email-date">
            Odebrano: 
            {% if email.received_at %}
              {{ email.received_at.strftime('%d.%m.%Y o %H:%M') }}
            {% else %}
              brak daty
            {% endif %}
          </div>
        </div>
      </div>

      <div class="email-body">
        <div class="email-body-header">Tre wiadomoci:</div>
        <div class="email-content">{{ email.content }}</div>
        
        {% if email.summary %}
        <div class="email-summary" id="summary-{{ email.id }}" style="display: none;">
          <strong>Streszczenie:</strong>
          <div class="email-summary-content">{{ email.summary }}</div>
        </div>
        {% endif %}

        <div class="reply-section">
          <form method="post" action="/reply">
            <input type="hidden" name="email_id" value="{{ email.id }}">
            <h4>Odpowied藕 na wiadomo</h4>
            <textarea name="reply_text" id="reply_{{ email.id }}" class="reply-textarea" placeholder="Wpisz swoj odpowied藕...">{{ email.suggested_reply }}</textarea>
            <button type="submit">Wylij odpowied藕</button>
          </form>
        </div>
      </div>
    </div>
    {% else %}
      <div class="no-emails">
        <p>Brak wiadomoci do wywietlenia</p>
        <p style="margin-top: 0.5rem; font-size: 0.9rem;">Sprawd藕 inne kategorie lub dodaj nowe konto e-mail</p>
      </div>
    {% endfor %}
  </div>

  <script>
    // Funkcja do liczenia s贸w
    function countWords(text) {
      return text.trim().split(/\s+/).filter(word => word.length > 0).length;
    }

    // Funkcja do pokazywania/ukrywania streszcze na podstawie liczby s贸w
    function toggleSummaries() {
      const emailCards = document.querySelectorAll('.email-card');
      
      emailCards.forEach(card => {
        const content = card.querySelector('.email-content');
        const summary = card.querySelector('.email-summary');
        
        if (content) {
          const text = content.textContent.trim();
          const charCount = text.length;  // liczba znak贸w z odstpami
          
          // Pokazuj streszczenie jeli tekst ma wicej ni偶 300 znak贸w
          if (summary && charCount > 300) {
            summary.style.display = 'block';
          }
        }
      });
    }

    // Uruchom po zaadowaniu strony
    document.addEventListener('DOMContentLoaded', toggleSummaries);

    // Smooth scroll dla link贸w
    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
      anchor.addEventListener('click', function (e) {
        e.preventDefault();
        document.querySelector(this.getAttribute('href')).scrollIntoView({
          behavior: 'smooth'
        });
      });
    });

    // Auto-resize dla textarea
    document.querySelectorAll('textarea').forEach(textarea => {
      textarea.addEventListener('input', function() {
        this.style.height = 'auto';
        this.style.height = this.scrollHeight + 'px';
      });
    });
  </script>
</body>
</html>