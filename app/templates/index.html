<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>System Maili U≈ºytkownik√≥w</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/water.css@2/out/water.css">
  <style>
    /* Minimalne dostosowania do water.css */
    body {
      max-width: 1200px;
      margin: 0 auto;
      padding: 1rem;
    }
          .logout-button {
        display: inline-block;
        background: #6c757d;
        color: white;
        padding: 0.5rem 1rem;
        border-radius: 4px;
        text-decoration: none;
        font-size: 0.9rem;
        transition: background-color 0.2s;
      }

      .logout-button:hover {
        background: #5a6268;
        color: white;
      }

    .header {
      text-align: center;
      margin-bottom: 2rem;
      padding-bottom: 1rem;
      border-bottom: 2px solid var(--border);
    }

    .controls-section {
      background: var(--background-alt);
      padding: 1.5rem;
      border-radius: 8px;
      margin-bottom: 2rem;
      border: 1px solid var(--border);
    }

    .form-group {
      margin-bottom: 1rem;
    }

    .email-accounts-tabs,
    .category-tabs {
      background: var(--background-alt);
      padding: 1rem;
      border-radius: 8px;
      margin: 1rem 0;
      border: 1px solid var(--border);
    }

    .email-accounts-tabs h3,
    .category-tabs h3 {
      text-align: center;
      margin-bottom: 1rem;
      color: var(--text-main);
    }

    .tabs-container {
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
      justify-content: center;
    }

    .account-tab,
    .tab-link {
      display: inline-block;
      padding: 0.5rem 1rem;
      background: var(--background);
      color: var(--text-main);
      text-decoration: none;
      border: 1px solid var(--border);
      border-radius: 4px;
      transition: all 0.2s ease;
      cursor: pointer;
    }

    .account-tab:hover,
    .tab-link:hover,
    .account-tab.active,
    .tab-link.active {
      background: var(--button-base);
      color: var(--button-text);
      text-decoration: none;
    }

    .email-card {
      background: var(--background-alt);
      border: 1px solid var(--border);
      border-radius: 8px;
      margin-bottom: 2rem;
      overflow: hidden;
    }

    .email-header {
      background: var(--background);
      padding: 1.5rem;
      border-bottom: 1px solid var(--border);
    }

    .email-meta {
      display: flex;
      flex-wrap: wrap;
      gap: 1rem;
      margin-bottom: 1rem;
    }

    .email-meta-item {
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .email-meta-label {
      font-weight: bold;
      color: var(--text-main);
    }

    .email-subject {
      font-size: 1.1rem;
      font-weight: bold;
      margin-bottom: 1rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .classification-date-row {
      display: flex;
      justify-content: space-between;
      align-items: flex-end;
      flex-wrap: wrap;
      gap: 0.5rem;
    }

    .classification-badge {
      background: var(--button-base);
      color: var(--button-text);
      padding: 0.3rem 0.8rem;
      border-radius: 20px;
      font-weight: bold;
      font-size: 0.9rem;
    }

    .email-date {
      color: var(--text-muted);
      font-size: 0.9rem;
    }

    .email-body {
      padding: 1.5rem;
    }

    .email-body-header {
      font-weight: bold;
      margin-bottom: 0.5rem;
      font-size: 1rem;
    }

    .email-content {
      background: var(--background);
      border: 1px solid var(--border);
      border-radius: 4px;
      padding: 1rem;
      margin-bottom: 1rem;
      white-space: pre-wrap;
      max-height: 300px;
      overflow-y: auto;
      word-wrap: break-word;
    }

    .email-summary {
      background: var(--background);
      border: 1px solid var(--border);
      border-radius: 4px;
      padding: 1rem;
      margin-bottom: 1rem;
    }

    .email-summary strong {
      display: block;
      margin-bottom: 0.5rem;
    }

    .reply-section {
      background: var(--background);
      border-top: 1px solid var(--border);
      padding: 1.5rem;
    }

    .reply-section h4 {
      margin-bottom: 1rem;
    }

    .reply-textarea {
      width: 100%;
      min-height: 120px;
      resize: vertical;
      margin-bottom: 1rem;
    }

    /* Styl dla sekcji z timerem */
    .pending-reply-section {
      background: #fff3cd;
      border: 1px solid #ffeaa7;
      border-radius: 4px;
      padding: 1rem;
      margin-top: 1rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      gap: 1rem;
    }

    .pending-reply-info {
      flex: 1;
    }

    .pending-reply-timer {
      font-weight: bold;
      color: #856404;
      font-size: 1.1rem;
    }

    .pending-reply-text {
      font-size: 0.9rem;
      color: #6c757d;
      margin-top: 0.5rem;
      font-style: italic;
    }

    .cancel-reply-button {
      background: #dc3545;
      color: white;
      padding: 0.5rem 1rem;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      text-decoration: none;
      font-size: 0.9rem;
      transition: background-color 0.2s;
    }

    .cancel-reply-button:hover {
      background: #c82333;
      text-decoration: none;
      color: white;
    }

    .message {
      text-align: center;
      padding: 1rem;
      border-radius: 4px;
      margin: 1rem 0;
    }

    .message.error, .error-message {
      background: #fee;
      border: 1px solid #fcc;
      color: #c33;
      padding: 0.5rem;
      border-radius: 4px;
      margin-top: 0.5rem;
    }

    .message.success, .success-message {
      background: #efe;
      border: 1px solid #cfc;
      color: #393;
      padding: 0.5rem;
      border-radius: 4px;
      margin-top: 0.5rem;
    }

    .no-emails {
      text-align: center;
      padding: 3rem;
      color: var(--text-muted);
    }

    /* Loading spinner */
    .loading-spinner {
      display: none;
      text-align: center;
      padding: 2rem;
    }

    .spinner {
      border: 4px solid #f3f3f3;
      border-top: 4px solid var(--button-base);
      border-radius: 50%;
      width: 40px;
      height: 40px;
      animation: spin 1s linear infinite;
      margin: 0 auto;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    /* Responsywno≈õƒá */
    @media (max-width: 768px) {
      .email-meta {
        flex-direction: column;
        gap: 0.5rem;
      }
      
      .classification-date-row {
        flex-direction: column;
        align-items: flex-start;
      }
      
      .tabs-container {
        flex-direction: column;
      }
      
      .account-tab,
      .tab-link {
        text-align: center;
      }

      .pending-reply-section {
        flex-direction: column;
        align-items: flex-start;
      }
    }
  </style>
</head>
<body>
  <div class="header">
    <h1>System Maili U≈ºytkownik√≥w</h1>
  </div>

<div class="controls-section">
  <div style="display: flex; justify-content: space-between; align-items: flex-start; flex-wrap: wrap; gap: 2rem;">
    
    <!-- Sekcja DODAWANIA konta -->
    <div style="flex: 1; min-width: 300px;">
      <h3>Dodaj nowe konto e-mail</h3>
      <form id="add-email-form">
        <div class="form-group">
          <label for="email_address">Adres e-mail:</label>
          <input type="email" id="email_address" name="email_address" required placeholder="przyklad@firma.pl">
        </div>
        <button type="submit" style = 'background-color: #393;'>Dodaj konto</button>
      </form>
      <div id="add-email-messages"></div>
    </div>

    <!-- Sekcja USUWANIA konta -->
    <div id="remove-email-section" style="flex: 1; min-width: 300px; margin-top: 0;">
      <h3>Usu≈Ñ konto e-mail</h3>
      <form id="remove-email-form">
        <div class="form-group">
          <label for="remove_email_address">Wybierz adres do usuniƒôcia:</label>
          <select id="remove_email_address" name="email_address" required>
            <option value="">-- Wybierz adres --</option>
          </select>
        </div>
        <button type="submit" style="background-color: #dc3545; border-color: #dc3545;">Usu≈Ñ konto</button>
      </form>
      <div id="remove-email-messages"></div>
    </div>

    <!-- Przycisk Wyloguj -->
    <div style="align-self: flex-start;">
      <a href="/logout" class="logout-button">Wyloguj siƒô</a>
    </div>
  </div>
</div>


  <!-- Taby wyboru kont email -->
  <div class="email-accounts-tabs">
    <h3>üìß Wybierz konto e-mail</h3>
    <div class="tabs-container" id="email-accounts-container">
      <div class="account-tab active" data-email="" data-category="">
        Wszystkie konta
      </div>
      <!-- Dynamically populated -->
    </div>
  </div>

  <!-- Taby kategorii -->
  <div class="category-tabs">
    <h3>Kategorie wiadomo≈õci</h3>
    <div class="tabs-container" id="categories-container">
      <div class="tab-link active" data-category="" data-email="">
        Wszystkie
      </div>
      <div class="tab-link" data-category="faktura" data-email="">
        Faktury
      </div>
      <div class="tab-link" data-category="reklamacja" data-email="">
        Reklamacje
      </div>
      <div class="tab-link" data-category="oferta" data-email="">
        Oferty
      </div>
      <div class="tab-link" data-category="rezygnacja" data-email="">
        Rezygnacje
      </div>
      <div class="tab-link" data-category="brak klasyfikacji" data-email="">
        Inne
      </div>
      <div class="tab-link" data-category="archiwum" data-email="">
        Archiwum
      </div>
    </div>
  </div>

  <div id="messages-container"></div>

  <div class="loading-spinner" id="loading-spinner">
    <div class="spinner"></div>
    <p>≈Åadowanie...</p>
  </div>

  <div class="emails-section" id="emails-container">
    <!-- Dynamically populated -->
  </div>

  <script>
    // === GLOBALNE ZMIENNE ===
    let currentState = {
      selectedEmail: '',
      activeCategory: '',
      userVisibleEmails: [],
      pendingEmails: [],
      countdownIntervals: new Map()
    };

    // === FUNKCJE POMOCNICZE ===
    
    function showLoading() {
      document.getElementById('loading-spinner').style.display = 'block';
      document.getElementById('emails-container').style.opacity = '0.5';
    }

    function hideLoading() {
      document.getElementById('loading-spinner').style.display = 'none';
      document.getElementById('emails-container').style.opacity = '1';
    }

    function showMessage(message, type = 'success') {
      const container = document.getElementById('messages-container');
      container.innerHTML = `<div class="message ${type}">${message}</div>`;
      setTimeout(() => {
        container.innerHTML = '';
      }, 5000);
    }

    function showAddEmailMessage(message, type = 'success') {
      const container = document.getElementById('add-email-messages');
      const className = type === 'error' ? 'error-message' : 'success-message';
      container.innerHTML = `<div class="${className}">${message}</div>`;
      setTimeout(() => {
        container.innerHTML = '';
      }, 5000);
    }

    function showRemoveEmailMessage(message, type = 'success') {
      const container = document.getElementById('remove-email-messages');
      const className = type === 'error' ? 'error-message' : 'success-message';
      container.innerHTML = `<div class="${className}">${message}</div>`;
      setTimeout(() => {
        container.innerHTML = '';
      }, 5000);
    }

    // === FUNKCJE AKTUALIZACJI UI ===

    function updateActiveTab(container, activeValue, attribute) {
      container.querySelectorAll('.account-tab, .tab-link').forEach(tab => {
        tab.classList.remove('active');
        if (tab.dataset[attribute] === activeValue) {
          tab.classList.add('active');
        }
      });
    }

    function updateEmailAccountsTabs() {
      const container = document.getElementById('email-accounts-container');
      
      container.innerHTML = `
        <div class="account-tab ${!currentState.selectedEmail ? 'active' : ''}" data-email="" data-category="${currentState.activeCategory}">
          Wszystkie konta
        </div>
      `;
      
      currentState.userVisibleEmails.forEach(email => {
        container.innerHTML += `
          <div class="account-tab ${email === currentState.selectedEmail ? 'active' : ''}" 
               data-email="${email}" data-category="${currentState.activeCategory}" title="${email}">
            ${email}
          </div>
        `;
      });

      // Aktualizuj sekcjƒô usuwania
      updateRemoveEmailSection();

      // Dodaj event listenery
      container.querySelectorAll('.account-tab').forEach(tab => {
        tab.addEventListener('click', () => {
          currentState.selectedEmail = tab.dataset.email;
          loadEmails();
        });
      });
    }

    function updateRemoveEmailSection() {
      const removeSection = document.getElementById('remove-email-section');
      const removeSelect = document.getElementById('remove_email_address');

      // Sekcja zawsze widoczna
      removeSection.style.display = 'block';

      // Zawsze pokazuj select z opcjami (nawet je≈õli pusty)
      removeSelect.innerHTML = '<option value="">-- Brak dostƒôpnych adres√≥w --</option>';

      currentState.userVisibleEmails.forEach(email => {
        removeSelect.innerHTML += `<option value="${email}">${email}</option>`;
      });
    }


    function updateCategoryTabs() {
      const container = document.getElementById('categories-container');
      const categories = [
        { key: '', label: 'Wszystkie' },
        { key: 'faktura', label: 'Faktury' },
        { key: 'reklamacja', label: 'Reklamacje' },
        { key: 'oferta', label: 'Oferty' },
        { key: 'rezygnacja', label: 'Rezygnacje' },
        { key: 'brak klasyfikacji', label: 'Inne' },
        { key: 'archiwum', label: 'Archiwum' }
      ];

      container.innerHTML = '';
      categories.forEach(cat => {
        container.innerHTML += `
          <div class="tab-link ${cat.key === currentState.activeCategory ? 'active' : ''}" 
               data-category="${cat.key}" data-email="${currentState.selectedEmail}">
            ${cat.label}
          </div>
        `;
      });

      // Dodaj event listenery
      container.querySelectorAll('.tab-link').forEach(tab => {
        tab.addEventListener('click', () => {
          currentState.activeCategory = tab.dataset.category;
          loadEmails();
        });
      });
    }

    // === FUNKCJE ODPOWIEDZI ===

    function setupReplyForms() {
      document.querySelectorAll('form[data-action="reply"]').forEach(form => {
        let sendImmediately = false;

        // Wy≈Çap klikniƒôcie przycisku i ustaw flagƒô
        form.querySelectorAll('button[type="submit"]').forEach(button => {
          button.addEventListener('click', (e) => {
            sendImmediately = button.value === 'true';
          });
        });

        form.addEventListener('submit', async (e) => {
          e.preventDefault();

          const formData = new FormData(form);
          formData.set('send_immediately', sendImmediately ? 'true' : 'false');

          const button = form.querySelector('button[type="submit"]:focus') || form.querySelector('button[type="submit"]');
          const originalText = button.textContent;

          button.disabled = true;
          button.textContent = sendImmediately ? 'Wysy≈Çanie teraz...' : 'Wysy≈Çanie...';

          try {
            const response = await fetch('/reply', {
              method: 'POST',
              body: formData
            });

            if (response.ok) {
              showMessage(sendImmediately ? 'Odpowied≈∫ wys≈Çana!' : 'Odpowied≈∫ zosta≈Ça zaplanowana!');
              loadEmails(); // Od≈õwie≈º emaile
            } else {
              showMessage('B≈ÇƒÖd podczas wysy≈Çania odpowiedzi', 'error');
            }
          } catch (error) {
            showMessage('B≈ÇƒÖd po≈ÇƒÖczenia', 'error');
          } finally {
            button.disabled = false;
            button.textContent = originalText;
          }
        });
      });
    }

    function setupCancelButtons() {
      document.querySelectorAll('.cancel-reply-button').forEach(button => {
        button.addEventListener('click', async (e) => {
          e.preventDefault();
          
          if (!confirm('Czy na pewno chcesz anulowaƒá wys≈Çanie tego emaila?')) {
            return;
          }
          
          const scheduledEmailId = button.dataset.scheduledId;
          const originalText = button.textContent;
          
          button.disabled = true;
          button.textContent = 'Anulowanie...';
          
          try {
            const response = await fetch(`/cancel_reply/${scheduledEmailId}`, {
              method: 'POST'
            });
            
            if (response.ok) {
              showMessage('Wys≈Çanie emaila zosta≈Ço anulowane');
              loadEmails(); // Od≈õwie≈º emaile
            } else {
              showMessage('B≈ÇƒÖd podczas anulowania', 'error');
            }
          } catch (error) {
            showMessage('B≈ÇƒÖd po≈ÇƒÖczenia', 'error');
          } finally {
            button.disabled = false;
            button.textContent = originalText;
          }
        });
      });
    }

    // === FUNKCJE TIMERA ===

    function clearAllCountdowns() {
      currentState.countdownIntervals.forEach(interval => clearInterval(interval));
      currentState.countdownIntervals.clear();
    }

    function startCountdown(scheduledEmailId, scheduledTime) {
      const countdownElement = document.getElementById(`countdown-${scheduledEmailId}`);
      if (!countdownElement) return;

      const interval = setInterval(() => {
        const now = new Date();
        const scheduledDate = new Date(scheduledTime + 'Z');
        const timeDiff = scheduledDate - now;
        
        if (timeDiff > 0) {
          const minutes = Math.floor(timeDiff / 60000);
          const seconds = Math.floor((timeDiff % 60000) / 1000);
          countdownElement.textContent = `${minutes}:${seconds.toString().padStart(2, '0')}`;
        } else {
          countdownElement.textContent = 'Wysy≈Çanie...';
          clearInterval(interval);
          currentState.countdownIntervals.delete(scheduledEmailId);
          // Od≈õwie≈º emaile po 2 sekundach
          setTimeout(() => loadEmails(), 2000);
        }
      }, 1000);

      currentState.countdownIntervals.set(scheduledEmailId, interval);
    }

    function setupCountdowns() {
      clearAllCountdowns();
      currentState.pendingEmails.forEach(scheduledEmail => {
        startCountdown(scheduledEmail.id, scheduledEmail.scheduled_time);
      });
    }

    // === FUNKCJE ≈ÅADOWANIA DANYCH ===

    async function loadEmails() {
      showLoading();
      
      try {
        const params = new URLSearchParams();
        
        // Dodaj parametry do URL
        if (currentState.activeCategory) {
          params.set('category', currentState.activeCategory);
        }
        if (currentState.selectedEmail) {
          params.set('selected_email', currentState.selectedEmail);
        }
        
        // U≈ºyj API endpoint
        let url = '/api/emails';
        if (params.toString()) {
          url += '?' + params.toString();
        }

        const response = await fetch(url, {
          headers: {
            'Accept': 'application/json'
          }
        });
        
        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        const data = await response.json();
        
        // Aktualizuj stan
        currentState.userVisibleEmails = data.userVisibleEmails || [];
        currentState.pendingEmails = data.pendingEmails || [];
        
        // Aktualizuj UI
        updateEmailAccountsTabs();
        updateCategoryTabs();
        renderEmails(data.emails || []);
        
        // Skonfiguruj interakcje
        setupReplyForms();
        setupCancelButtons();
        setupCountdowns();
        toggleSummaries();
        setupTextareaAutoResize();
        
      } catch (error) {
        console.error('Error loading emails:', error);
        showMessage('B≈ÇƒÖd podczas ≈Çadowania emaili: ' + error.message, 'error');
      } finally {
        hideLoading();
      }
    }

    function renderEmails(emails) {
      const container = document.getElementById('emails-container');
      
      if (emails.length === 0) {
        container.innerHTML = `
          <div class="no-emails">
            <p>Brak wiadomo≈õci do wy≈õwietlenia</p>
            <p style="margin-top: 0.5rem; font-size: 0.9rem;">Sprawd≈∫ inne kategorie lub dodaj nowe konto e-mail</p>
          </div>
        `;
        return;
      }

      container.innerHTML = emails.map(email => {
        const pendingForEmail = currentState.pendingEmails.find(p => p.email_id === email.id);
        
        return `
          <div class="email-card">
            <div class="email-header">
              <div class="email-meta">
                <div class="email-meta-item">
                  <span class="email-meta-label">Od:</span>
                  <span>${email.sent_from}</span>
                </div>
                <div class="email-meta-item">
                  <span class="email-meta-label">Do:</span>
                  <span>${email.sent_to}</span>
                </div>
              </div>
              
              <div class="email-subject">
                <span class="email-meta-label">Temat:</span>
                <span>${email.subject}</span>
              </div>

              <div class="classification-date-row">
                <div class="classification-badge">
                  ${email.classification}
                </div>

                <div class="email-date">
                  Odebrano: 
                  ${email.received_at ? new Date(email.received_at).toLocaleString('pl-PL') : 'brak daty'}
                </div>
              </div>
            </div>

            <div class="email-body">
              <div class="email-body-header">Tre≈õƒá wiadomo≈õci:</div>
              <div class="email-content">${email.content}</div>
              
              ${email.summary ? `
                <div class="email-summary" id="summary-${email.id}" style="display: none;">
                  <strong>Streszczenie:</strong>
                  <div class="email-summary-content">${email.summary}</div>
                </div>
              ` : ''}

              ${currentState.activeCategory !== 'archiwum' ? `
                <div class="reply-section">
                  ${pendingForEmail ? `
                    <div class="pending-reply-section">
                      <div class="pending-reply-info">
                        <div class="pending-reply-timer">
                          ‚è∞ Odpowied≈∫ zostanie wys≈Çana za: <span id="countdown-${pendingForEmail.id}"></span>
                        </div>
                        <div class="pending-reply-text">
                          "${pendingForEmail.reply_text.length > 100 ? pendingForEmail.reply_text.substring(0, 2000) : pendingForEmail.reply_text}"
                        </div>
                      </div>
                      <button class="cancel-reply-button" data-scheduled-id="${pendingForEmail.id}">
                        Anuluj wys≈Çanie
                      </button>
                    </div>
                  ` : `
                    <form data-action="reply" style="display: flex; flex-wrap: wrap; gap: 0.5rem; align-items: center;">
                      <input type="hidden" name="email_id" value="${email.id}">
                      <h4 style="flex-basis: 100%;">Odpowied≈∫ na wiadomo≈õƒá</h4>
                      <textarea name="reply_text" id="reply_${email.id}" class="reply-textarea" placeholder="Wpisz swojƒÖ odpowied≈∫...">${email.suggested_reply || ''}</textarea>

                      <button type="submit" name="send_immediately" value="false" style="flex-grow: 1;">
                        Zaplanuj odpowied≈∫ (wy≈õle siƒô za 5 min)
                      </button>
                      <button type="submit" name="send_immediately" value="true" style="flex-grow: 1; background-color: #28a745; color: white;">
                        Wy≈õlij teraz
                      </button>
                    </form>
                  `}
                </div>
              ` : `
                <div class="reply-section" style="text-align: center; color: #6c757d; font-style: italic;">
                  üìÅ Wiadomo≈õƒá w archiwum - brak mo≈ºliwo≈õci odpowiedzi
                </div>
              `}
            </div>
          </div>
        `;
      }).join('');
    }

    // === DODATKOWE FUNKCJE ===

    function toggleSummaries() {
      const emailCards = document.querySelectorAll('.email-card');
      
      emailCards.forEach(card => {
        const content = card.querySelector('.email-content');
        const summary = card.querySelector('.email-summary');
        
        if (content) {
          const text = content.textContent.trim();
          const charCount = text.length;
          
          if (summary && charCount > 300) {
            summary.style.display = 'block';
          }
        }
      });
    }

    function setupTextareaAutoResize() {
      document.querySelectorAll('textarea').forEach(textarea => {
        textarea.addEventListener('input', function() {
          this.style.height = 'auto';
          this.style.height = this.scrollHeight + 'px';
        });
      });
    }

    // === INICJALIZACJA ===

    document.addEventListener('DOMContentLoaded', function() {
      // Skonfiguruj formularz dodawania emaila
      document.getElementById('add-email-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        
        const formData = new FormData(e.target);
        const button = e.target.querySelector('button[type="submit"]');
        const originalText = button.textContent;
        
        button.disabled = true;
        button.textContent = 'Dodawanie...';
        
        try {
          const response = await fetch('/api/add_email_account', {
            method: 'POST', 
            body: formData
          });
          
          if (response.ok) {
            const result = await response.json();
            showAddEmailMessage(result.message);
            e.target.reset();
            loadEmails(); // Od≈õwie≈º dane
          } else {
            const error = await response.json();
            showAddEmailMessage(error.detail, 'error');
          }
        } catch (error) {
          showAddEmailMessage('B≈ÇƒÖd po≈ÇƒÖczenia', 'error');
        } finally {
          button.disabled = false;
          button.textContent = originalText;
        }
      });

      // Skonfiguruj formularz usuwania emaila
      document.getElementById('remove-email-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        
        const formData = new FormData(e.target);
        const button = e.target.querySelector('button[type="submit"]');
        const originalText = button.textContent;
        
        button.disabled = true;
        button.textContent = 'Usuwanie...';
        
        try {
          const response = await fetch('/api/remove_email_account', {
            method: 'POST', 
            body: formData
          });
          
          if (response.ok) {
            const result = await response.json();
            showRemoveEmailMessage(result.message);
            e.target.reset();
            loadEmails(); // Od≈õwie≈º dane
          } else {
            const error = await response.json();
            showRemoveEmailMessage(error.detail, 'error');
          }
        } catch (error) {
          showRemoveEmailMessage('B≈ÇƒÖd po≈ÇƒÖczenia', 'error');
        } finally {
          button.disabled = false;
          button.textContent = originalText;
        }
      });
      // Za≈Çaduj poczƒÖtkowe dane
      loadEmails();
    });
  </script>
</body>
</html>